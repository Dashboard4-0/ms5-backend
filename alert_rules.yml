# MS5.0 Floor Dashboard - Prometheus Alert Rules

groups:
  # System Health Alerts
  - name: system_health
    rules:
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: high
          service: infrastructure
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 5 minutes on {{ $labels.instance }}"

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: high
          service: infrastructure
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for more than 5 minutes on {{ $labels.instance }}"

      - alert: DiskSpaceLow
        expr: (node_filesystem_size_bytes - node_filesystem_free_bytes) / node_filesystem_size_bytes * 100 > 90
        for: 5m
        labels:
          severity: high
          service: infrastructure
        annotations:
          summary: "Disk space low"
          description: "Disk usage is above 90% on {{ $labels.instance }} mount {{ $labels.mountpoint }}"

      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          service: infrastructure
        annotations:
          summary: "Service is down"
          description: "{{ $labels.job }} service on {{ $labels.instance }} has been down for more than 1 minute"

  # Database Alerts
  - name: database_health
    rules:
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database on {{ $labels.instance }} has been down for more than 1 minute"

      - alert: PostgreSQLHighConnections
        expr: pg_stat_database_numbackends / pg_settings_max_connections * 100 > 80
        for: 5m
        labels:
          severity: high
          service: database
        annotations:
          summary: "High PostgreSQL connections"
          description: "PostgreSQL connection usage is above 80% on {{ $labels.instance }}"

      - alert: PostgreSQLSlowQueries
        expr: rate(pg_stat_database_tup_returned[5m]) < 1000
        for: 10m
        labels:
          severity: medium
          service: database
        annotations:
          summary: "Slow PostgreSQL queries"
          description: "PostgreSQL query performance is degraded on {{ $labels.instance }}"

      - alert: PostgreSQLReplicationLag
        expr: pg_stat_replication_lag > 60
        for: 5m
        labels:
          severity: high
          service: database
        annotations:
          summary: "PostgreSQL replication lag"
          description: "PostgreSQL replication lag is {{ $value }} seconds on {{ $labels.instance }}"

  # Application Alerts
  - name: application_health
    rules:
      - alert: BackendAPIHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High API response time"
          description: "95th percentile API response time is above 2 seconds on {{ $labels.instance }}"

      - alert: BackendAPIHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High API error rate"
          description: "API error rate is above 5% on {{ $labels.instance }}"

      - alert: BackendAPIHighRequestRate
        expr: rate(http_requests_total[5m]) > 1000
        for: 5m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "High API request rate"
          description: "API request rate is above 1000 requests/second on {{ $labels.instance }}"

      - alert: BackendAPIUnavailable
        expr: up{job="ms5-backend"} == 0
        for: 1m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Backend API is unavailable"
          description: "Backend API on {{ $labels.instance }} has been down for more than 1 minute"

  # Production System Alerts
  - name: production_system
    rules:
      - alert: ProductionLineDown
        expr: ms5_production_line_status{status="down"} > 0
        for: 2m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Production line is down"
          description: "Production line {{ $labels.line_id }} has been down for more than 2 minutes"

      - alert: EquipmentOffline
        expr: ms5_equipment_status{status="offline"} > 0
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "Equipment is offline"
          description: "Equipment {{ $labels.equipment_code }} has been offline for more than 5 minutes"

      - alert: LowOEEScore
        expr: ms5_oee_score < 70
        for: 15m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "Low OEE score"
          description: "OEE score is below 70% for line {{ $labels.line_id }} for more than 15 minutes"

      - alert: HighDowntime
        expr: ms5_downtime_duration_minutes > 60
        for: 10m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High downtime duration"
          description: "Downtime duration is above 60 minutes for equipment {{ $labels.equipment_code }}"

  # Andon System Alerts
  - name: andon_system
    rules:
      - alert: CriticalAndonEvent
        expr: ms5_andon_events_total{priority="critical", status="active"} > 0
        for: 0m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Critical Andon event active"
          description: "Critical Andon event {{ $labels.event_id }} is active on line {{ $labels.line_id }}"

      - alert: AndonEventNotAcknowledged
        expr: ms5_andon_events_total{status="active"} > 0 and ms5_andon_events_acknowledged_total == 0
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "Andon event not acknowledged"
          description: "Andon event {{ $labels.event_id }} has not been acknowledged for more than 5 minutes"

      - alert: AndonEscalationRequired
        expr: ms5_andon_escalations_total{status="overdue"} > 0
        for: 0m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Andon escalation overdue"
          description: "Andon escalation {{ $labels.escalation_id }} is overdue for event {{ $labels.event_id }}"

      - alert: HighAndonEventRate
        expr: rate(ms5_andon_events_total[5m]) > 10
        for: 5m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "High Andon event rate"
          description: "Andon event rate is above 10 events/minute on line {{ $labels.line_id }}"

  # Job Management Alerts
  - name: job_management
    rules:
      - alert: JobAssignmentOverdue
        expr: ms5_job_assignments_overdue_total > 0
        for: 0m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "Job assignment overdue"
          description: "Job assignment {{ $labels.job_id }} is overdue for operator {{ $labels.operator_id }}"

      - alert: HighJobFailureRate
        expr: rate(ms5_job_assignments_total{status="failed"}[5m]) / rate(ms5_job_assignments_total[5m]) * 100 > 20
        for: 10m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High job failure rate"
          description: "Job failure rate is above 20% for more than 10 minutes"

      - alert: JobQueueBacklog
        expr: ms5_job_assignments_total{status="pending"} > 50
        for: 5m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "Job queue backlog"
          description: "Job queue has {{ $value }} pending jobs for more than 5 minutes"

  # WebSocket Alerts
  - name: websocket_system
    rules:
      - alert: WebSocketConnectionFailure
        expr: rate(ms5_websocket_connection_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High WebSocket connection failure rate"
          description: "WebSocket connection failure rate is above 10 failures/minute"

      - alert: WebSocketHighLatency
        expr: ms5_websocket_message_latency_seconds > 5
        for: 5m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "High WebSocket message latency"
          description: "WebSocket message latency is above 5 seconds"

      - alert: WebSocketConnectionCount
        expr: ms5_websocket_active_connections > 500
        for: 5m
        labels:
          severity: medium
          service: application
        annotations:
          summary: "High WebSocket connection count"
          description: "WebSocket active connections count is above 500"

  # Quality Management Alerts
  - name: quality_management
    rules:
      - alert: QualityCheckFailed
        expr: ms5_quality_checks_total{status="failed"} > 0
        for: 0m
        labels:
          severity: high
          service: application
        annotations:
          summary: "Quality check failed"
          description: "Quality check {{ $labels.check_id }} failed for product {{ $labels.product_id }}"

      - alert: HighQualityFailureRate
        expr: rate(ms5_quality_checks_total{status="failed"}[5m]) / rate(ms5_quality_checks_total[5m]) * 100 > 10
        for: 10m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High quality failure rate"
          description: "Quality failure rate is above 10% for more than 10 minutes"

  # Cache System Alerts
  - name: cache_system
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: infrastructure
        annotations:
          summary: "Redis cache is down"
          description: "Redis cache on {{ $labels.instance }} has been down for more than 1 minute"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: high
          service: infrastructure
        annotations:
          summary: "High Redis memory usage"
          description: "Redis memory usage is above 90% on {{ $labels.instance }}"

      - alert: RedisHighHitRate
        expr: redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total) * 100 < 80
        for: 10m
        labels:
          severity: medium
          service: infrastructure
        annotations:
          summary: "Low Redis hit rate"
          description: "Redis cache hit rate is below 80% on {{ $labels.instance }}"

  # Backup and Recovery Alerts
  - name: backup_recovery
    rules:
      - alert: BackupFailed
        expr: ms5_backup_status{status="failed"} > 0
        for: 0m
        labels:
          severity: high
          service: infrastructure
        annotations:
          summary: "Backup failed"
          description: "Backup {{ $labels.backup_id }} failed on {{ $labels.instance }}"

      - alert: BackupOverdue
        expr: time() - ms5_backup_last_success_timestamp > 86400
        for: 1h
        labels:
          severity: medium
          service: infrastructure
        annotations:
          summary: "Backup overdue"
          description: "Last successful backup was more than 24 hours ago on {{ $labels.instance }}"

  # Security Alerts
  - name: security
    rules:
      - alert: HighFailedLoginAttempts
        expr: rate(ms5_auth_login_failed_total[5m]) > 10
        for: 5m
        labels:
          severity: high
          service: application
        annotations:
          summary: "High failed login attempts"
          description: "Failed login attempt rate is above 10 attempts/minute"

      - alert: SuspiciousActivity
        expr: rate(ms5_auth_suspicious_activity_total[5m]) > 5
        for: 2m
        labels:
          severity: high
          service: application
        annotations:
          summary: "Suspicious activity detected"
          description: "Suspicious activity rate is above 5 events/minute"

      - alert: UnauthorizedAccess
        expr: rate(ms5_auth_unauthorized_access_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
          service: application
        annotations:
          summary: "Unauthorized access attempt"
          description: "Unauthorized access attempt detected on {{ $labels.endpoint }}"
